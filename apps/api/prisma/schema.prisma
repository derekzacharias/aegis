generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                     String                  @id @default(cuid())
  name                   String
  slug                   String                  @unique
  impactLevel            ImpactLevel             @default(MODERATE)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  users                  User[]
  frameworks             Framework[]
  assessments            AssessmentProject[]
  assessmentAuditLogs    AssessmentAuditLog[]
  evidenceItems          EvidenceItem[]
  tasks                  Task[]
  reports                ReportArtifact[]
  integrations           IntegrationConnection[]
  policies               PolicyDocument[]
  evidenceUploadRequests EvidenceUploadRequest[]
  schedules              Schedule[]
}

model User {
  id                      String                  @id @default(cuid())
  email                   String                  @unique
  firstName               String?
  lastName                String?
  passwordHash            String?
  refreshTokenHash        String?
  refreshTokenId          String?
  refreshTokenIssuedAt    DateTime?
  refreshTokenInvalidatedAt DateTime?
  passwordChangedAt       DateTime?
  lastLoginAt             DateTime?
  phoneNumber             String?
  jobTitle                String?
  timezone                String?
  avatarUrl               String?
  bio                     String?
  role                    UserRole                @default(ANALYST)
  organization            Organization            @relation(fields: [organizationId], references: [id])
  organizationId          String
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  assessments             AssessmentProject[]     @relation("AssessmentOwners")
  uploadedEvidence        EvidenceItem[]          @relation("EvidenceUploadedBy")
  reviewAssignments       EvidenceItem[]          @relation("EvidenceReviewer")
  evidenceUploadRequests  EvidenceUploadRequest[] @relation("EvidenceUploadRequestedBy")
  evidenceStatusChanges   EvidenceStatusHistory[] @relation("EvidenceStatusChangedBy")
  ownedPolicies           PolicyDocument[]
  createdPolicyVersions   PolicyVersion[]         @relation("CreatedPolicyVersions")
  submittedPolicyVersions PolicyVersion[]         @relation("SubmittedPolicyVersions")
  approvedPolicyVersions  PolicyVersion[]         @relation("ApprovedPolicyVersions")
  policyApprovals         PolicyApproval[]
  assessmentControls      AssessmentControl[]
  tasks                   Task[]
  reportRequests          ReportArtifact[]
  ownedSchedules          Schedule[]              @relation("ScheduleOwner")
  profileAuditEntries     UserProfileAudit[]      @relation("UserProfileChanges")
  profileAuditActions     UserProfileAudit[]      @relation("UserProfileAuditActor")
  assessmentAuditEntries  AssessmentAuditLog[]    @relation("AssessmentAuditActor")
  createdFrameworks       Framework[]             @relation("FrameworkCreator")
  updatedFrameworks       Framework[]             @relation("FrameworkUpdater")
  createdControls         Control[]               @relation("ControlCreator")
  updatedControls         Control[]               @relation("ControlUpdater")
}

model Framework {
  id                    String                @id @default(cuid())
  slug                  String
  name                  String
  version               String
  description           String
  family                FrameworkFamily
  status                FrameworkStatus       @default(DRAFT)
  isCustom              Boolean               @default(false)
  controlCount          Int                   @default(0)
  metadata              Json?
  organization          Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId        String
  createdBy             User?                 @relation("FrameworkCreator", fields: [createdById], references: [id])
  createdById           String?
  updatedBy             User?                 @relation("FrameworkUpdater", fields: [updatedById], references: [id])
  updatedById           String?
  publishedAt           DateTime?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  controls              Control[]
  assessmentMemberships AssessmentFramework[]
  evidenceMappings      EvidenceFramework[]

  @@unique([organizationId, slug])
  @@unique([organizationId, name, version])
}

model Control {
  id                 String              @id @default(cuid())
  framework          Framework           @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  frameworkId        String
  family             String
  title              String
  description        String
  priority           ControlPriority     @default(P2)
  kind               ControlKind         @default(BASE)
  parent             Control?            @relation("ControlHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  parentId           String?
  children           Control[]           @relation("ControlHierarchy")
  baselines          BaselineLevel[]     @default([])
  keywords           String[]            @default([])
  references         String[]            @default([])
  relatedControls    String[]            @default([])
  tags               String[]            @default([])
  metadata           Json?
  isCustom           Boolean             @default(false)
  createdBy          User?               @relation("ControlCreator", fields: [createdById], references: [id])
  createdById        String?
  updatedBy          User?               @relation("ControlUpdater", fields: [updatedById], references: [id])
  updatedById        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  sourceMappings     ControlMapping[]    @relation("ControlMappings")
  targetMappings     ControlMapping[]    @relation("TargetMappings")
  assessmentControls AssessmentControl[]
}

model ControlMapping {
  id              String                       @id @default(cuid())
  sourceControl   Control                      @relation("ControlMappings", fields: [sourceControlId], references: [id])
  sourceControlId String
  targetControl   Control                      @relation("TargetMappings", fields: [targetControlId], references: [id])
  targetControlId String
  confidence      Float                        @default(0.5)
  rationale       String?
  tags            String[]                     @default([])
  origin          ControlMappingOrigin         @default(SEED)
  evidenceHints   ControlMappingEvidenceHint[]
  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt

  @@unique([sourceControlId, targetControlId])
}

model UserProfileAudit {
  id        String   @id @default(cuid())
  user      User     @relation("UserProfileChanges", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  actor     User?    @relation("UserProfileAuditActor", fields: [actorId], references: [id])
  actorId   String?
  changes   Json
  createdAt DateTime @default(now())
}

model ControlMappingEvidenceHint {
  id         String         @id @default(cuid())
  mapping    ControlMapping @relation(fields: [mappingId], references: [id], onDelete: Cascade)
  mappingId  String
  evidence   EvidenceItem?  @relation(fields: [evidenceId], references: [id])
  evidenceId String?
  summary    String
  rationale  String?
  score      Float          @default(0.5)
  createdAt  DateTime       @default(now())
}

model AssessmentProject {
  id                  String                @id @default(cuid())
  name                String
  status              AssessmentStatus      @default(DRAFT)
  organization        Organization          @relation(fields: [organizationId], references: [id])
  organizationId      String
  owner               User?                 @relation("AssessmentOwners", fields: [ownerId], references: [id])
  ownerId             String?
  ownerEmail          String?
  targetMaturity      Int?                  @db.SmallInt
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  controls            AssessmentControl[]
  frameworks          AssessmentFramework[]
  reports             ReportArtifact[]
  tasks               Task[]
  auditLogs           AssessmentAuditLog[]
  progressSatisfied   Int                   @default(0)
  progressPartial     Int                   @default(0)
  progressUnsatisfied Int                   @default(0)
  progressTotal       Int                   @default(0)
}

model AssessmentFramework {
  id           String            @id @default(cuid())
  assessment   AssessmentProject @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  assessmentId String
  framework    Framework         @relation(fields: [frameworkId], references: [id])
  frameworkId  String
}

model AssessmentControl {
  id            String               @id @default(cuid())
  assessment    AssessmentProject    @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  assessmentId  String
  control       Control              @relation(fields: [controlId], references: [id])
  controlId     String
  status        ControlStatus        @default(UNASSESSED)
  owner         User?                @relation(fields: [ownerId], references: [id])
  ownerId       String?
  dueDate       DateTime?
  comments      String?
  evidenceLinks AssessmentEvidence[]
  tasks         Task[]
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
}

model EvidenceItem {
  id                  String                       @id @default(cuid())
  organization        Organization                 @relation(fields: [organizationId], references: [id])
  organizationId      String
  name                String
  storageUri          String
  storageKey          String
  storageProvider     EvidenceStorageProvider      @default(S3)
  originalFilename    String
  contentType         String
  fileSize            Int
  fileType            String                       @default("pdf")
  sizeInKb            Int                          @default(0)
  checksum            String?
  metadata            Json
  uploadedBy          User?                        @relation("EvidenceUploadedBy", fields: [uploadedById], references: [id])
  uploadedById        String?
  uploadedByEmail     String?
  reviewer            User?                        @relation("EvidenceReviewer", fields: [reviewerId], references: [id])
  reviewerId          String?
  uploadRequest       EvidenceUploadRequest?       @relation("UploadToEvidence", fields: [uploadRequestId], references: [id])
  uploadRequestId     String?                      @unique
  uploadedAt          DateTime                     @default(now())
  reviewDue           DateTime?
  retentionPeriodDays Int?
  retentionExpiresAt  DateTime?
  retentionReason     String?
  status              EvidenceStatus               @default(PENDING)
  ingestionStatus     EvidenceIngestionStatus      @default(PENDING)
  ingestionNotes      String?
  lastScanStatus      EvidenceScanStatus?
  lastScanAt          DateTime?
  lastScanEngine      String?
  lastScanSignatureVersion String?
  lastScanNotes       String?
  lastScanDurationMs  Int?
  lastScanBytes       Int?
  lastStatusChangeAt  DateTime                     @default(now())
  lastReviewed        DateTime?
  nextAction          String?
  displayControlIds   String[]                     @default([])
  displayFrameworkIds String[]                     @default([])
  controls            AssessmentEvidence[]
  frameworks          EvidenceFramework[]
  mappingHints        ControlMappingEvidenceHint[]
  statusHistory       EvidenceStatusHistory[]
  scans               EvidenceScan[]
}

model EvidenceUploadRequest {
  id              String                  @id @default(cuid())
  organization    Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId  String
  requestedBy     User?                   @relation("EvidenceUploadRequestedBy", fields: [requestedById], references: [id])
  requestedById   String?
  fileName        String
  contentType     String
  sizeInBytes     Int
  checksum        String?
  storageProvider EvidenceStorageProvider @default(S3)
  storageKey      String
  uploadUrl       String?
  uploadAuthToken String
  status          EvidenceUploadStatus    @default(PENDING)
  uploadExpiresAt DateTime
  uploadedAt      DateTime?
  confirmedAt     DateTime?
  retryCount      Int                     @default(0)
  failureReason   String?
  lastErrorAt     DateTime?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  evidence        EvidenceItem?           @relation("UploadToEvidence")
}

model EvidenceStatusHistory {
  id          String          @id @default(cuid())
  evidence    EvidenceItem    @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  evidenceId  String
  fromStatus  EvidenceStatus?
  toStatus    EvidenceStatus
  note        String?
  changedAt   DateTime        @default(now())
  changedBy   User?           @relation("EvidenceStatusChangedBy", fields: [changedById], references: [id])
  changedById String?
}

model EvidenceScan {
  id                String             @id @default(cuid())
  evidence          EvidenceItem       @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  evidenceId        String
  status            EvidenceScanStatus @default(PENDING)
  engine            String
  engineVersion     String?
  signatureVersion  String?
  startedAt         DateTime           @default(now())
  completedAt       DateTime?
  durationMs        Int?
  bytesScanned      Int?
  findings          Json?
  failureReason     String?
  quarantined       Boolean            @default(false)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([evidenceId])
}

model EvidenceFramework {
  id          String       @id @default(cuid())
  evidence    EvidenceItem @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  evidenceId  String
  framework   Framework    @relation(fields: [frameworkId], references: [id])
  frameworkId String
}

model AssessmentEvidence {
  id                  String            @id @default(cuid())
  assessmentControl   AssessmentControl @relation(fields: [assessmentControlId], references: [id], onDelete: Cascade)
  assessmentControlId String
  evidence            EvidenceItem      @relation(fields: [evidenceId], references: [id])
  evidenceId          String
  createdAt           DateTime          @default(now())

  @@unique([assessmentControlId, evidenceId])
}

model Task {
  id                  String             @id @default(cuid())
  assessment          AssessmentProject? @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  assessmentId        String?
  assessmentControl   AssessmentControl? @relation(fields: [assessmentControlId], references: [id], onDelete: SetNull)
  assessmentControlId String?
  organization        Organization       @relation(fields: [organizationId], references: [id])
  organizationId      String
  title               String
  description         String?
  status              TaskStatus         @default(OPEN)
  priority            TaskPriority       @default(MEDIUM)
  owner               User?              @relation(fields: [ownerId], references: [id])
  ownerId             String?
  dueDate             DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
}

model AssessmentAuditLog {
  id             String            @id @default(cuid())
  assessment     AssessmentProject @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  assessmentId   String
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  actor          User?             @relation("AssessmentAuditActor", fields: [actorId], references: [id])
  actorId        String?
  actorEmail     String?
  action         String
  metadata       Json?
  createdAt      DateTime          @default(now())
}

model ReportArtifact {
  id             String            @id @default(cuid())
  assessment     AssessmentProject @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  assessmentId   String
  organization   Organization      @relation(fields: [organizationId], references: [id])
  organizationId String
  format         ReportFormat
  storageUri     String
  requestedBy    User?             @relation(fields: [requestedById], references: [id])
  requestedById  String?
  createdAt      DateTime          @default(now())
}

model IntegrationConnection {
  id                 String                      @id @default(cuid())
  organization       Organization                @relation(fields: [organizationId], references: [id])
  organizationId     String
  provider           IntegrationProvider
  clientId           String
  clientSecret       String
  baseUrl            String
  oauthAccessToken   String?
  oauthRefreshToken  String?
  oauthExpiresAt     DateTime?
  oauthScopes        String[]                    @default([])
  webhookSecret      String?
  webhookUrl         String?
  mappingPreferences Json?
  lastSyncedAt       DateTime?
  lastWebhookAt      DateTime?
  status             IntegrationConnectionStatus @default(PENDING)
  statusMessage      String?
  syncCursor         String?
  createdAt          DateTime                    @default(now())
  updatedAt          DateTime                    @updatedAt
}

model Schedule {
  id             String            @id @default(cuid())
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String
  owner          User?             @relation("ScheduleOwner", fields: [ownerId], references: [id])
  ownerId        String?
  name           String
  description    String?
  type           ScheduleType
  frequency      ScheduleFrequency
  nextRun        DateTime
  lastRun        DateTime?
  isActive       Boolean           @default(true)
  options        Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
}

model PolicyDocument {
  id                String          @id @default(cuid())
  organization      Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId    String
  owner             User            @relation(fields: [ownerId], references: [id])
  ownerId           String
  title             String
  description       String?
  category          String?
  tags              String[]        @default([])
  reviewCadenceDays Int?
  currentVersion    PolicyVersion?  @relation("CurrentPolicyVersion", fields: [currentVersionId], references: [id])
  currentVersionId  String?         @unique
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  versions          PolicyVersion[]
}

model PolicyVersion {
  id            String              @id @default(cuid())
  document      PolicyDocument      @relation(fields: [policyId], references: [id], onDelete: Cascade)
  policyId      String
  versionNumber Int
  label         String?
  status        PolicyVersionStatus @default(DRAFT)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  createdBy     User                @relation("CreatedPolicyVersions", fields: [createdById], references: [id])
  createdById   String
  submittedAt   DateTime?
  submittedBy   User?               @relation("SubmittedPolicyVersions", fields: [submittedById], references: [id])
  submittedById String?
  approvedAt    DateTime?
  approvedBy    User?               @relation("ApprovedPolicyVersions", fields: [approvedById], references: [id])
  approvedById  String?
  effectiveAt   DateTime?
  notes         String?
  storagePath   String
  originalName  String
  mimeType      String
  fileSizeBytes Int
  checksum      String?
  isCurrent     Boolean             @default(false)
  approvals     PolicyApproval[]
  currentFor    PolicyDocument?     @relation("CurrentPolicyVersion")
  supersedes    PolicyVersion?      @relation("PolicyVersionSupersedes", fields: [supersedesId], references: [id])
  supersedesId  String?
  supersededBy  PolicyVersion[]     @relation("PolicyVersionSupersedes")

  @@unique([policyId, versionNumber])
}

model PolicyApproval {
  id              String               @id @default(cuid())
  version         PolicyVersion        @relation(fields: [policyVersionId], references: [id], onDelete: Cascade)
  policyVersionId String
  approver        User                 @relation(fields: [approverId], references: [id])
  approverId      String
  status          PolicyApprovalStatus @default(PENDING)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  decidedAt       DateTime?
  decisionComment String?

  @@unique([policyVersionId, approverId])
}

enum ImpactLevel {
  LOW
  MODERATE
  HIGH
}

enum IntegrationConnectionStatus {
  PENDING
  CONNECTED
  ERROR
}

enum ControlMappingOrigin {
  SEED
  ALGO
  MANUAL
}

enum UserRole {
  ADMIN
  ANALYST
  AUDITOR
  READ_ONLY
}

enum FrameworkFamily {
  NIST
  CIS
  PCI
  ISO
  CUSTOM
}

enum FrameworkStatus {
  DRAFT
  PUBLISHED
}

enum ControlPriority {
  P0
  P1
  P2
  P3
}

enum ControlKind {
  BASE
  ENHANCEMENT
}

enum BaselineLevel {
  LOW
  MODERATE
  HIGH
  PRIVACY
}

enum AssessmentStatus {
  DRAFT
  IN_PROGRESS
  COMPLETE
}

enum ControlStatus {
  UNASSESSED
  SATISFIED
  PARTIAL
  UNSATISFIED
  NOT_APPLICABLE
}

enum EvidenceStatus {
  PENDING
  APPROVED
  ARCHIVED
  QUARANTINED
}

enum EvidenceStorageProvider {
  S3
  LOCAL
}

enum EvidenceUploadStatus {
  PENDING
  UPLOADED
  CONFIRMED
  EXPIRED
  FAILED
}

enum EvidenceIngestionStatus {
  PENDING
  PROCESSING
  COMPLETED
  QUARANTINED
}

enum EvidenceScanStatus {
  PENDING
  RUNNING
  CLEAN
  INFECTED
  FAILED
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  BLOCKED
  COMPLETE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReportFormat {
  HTML
  PDF
}

enum IntegrationProvider {
  JIRA
  SERVICENOW
}

enum ScheduleType {
  EVIDENCE_REVIEW_REMINDER
  RECURRING_ASSESSMENT
  AGENT_HEALTH_CHECK
}

enum ScheduleFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  CUSTOM
}

enum PolicyVersionStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  REJECTED
  ARCHIVED
}

enum PolicyApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}
